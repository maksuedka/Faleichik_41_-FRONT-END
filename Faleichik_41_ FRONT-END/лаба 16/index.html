<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OOP Racing Game</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #222;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            background-color: #555;
            border-left: 5px solid white;
            border-right: 5px solid white;
        }

        /* Меню поверх игры */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #game-over-screen {
            background: rgba(0, 0, 0, 0.85);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid orange;
            text-align: center;
            color: white;
            pointer-events: auto;
            display: none;
        }

        h1 { margin: 0 0 20px 0; font-size: 30px; }
        p { font-size: 20px; margin-bottom: 20px; }

        button {
            background: orange;
            border: none;
            color: black;
            padding: 10px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.2s;
        }
        button:hover { background: #ffcc00; transform: scale(1.05); }

        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="canvas" width="400" height="600"></canvas>
        
        <!-- Интерфейс -->
        <div id="ui-layer">
            <div id="score-display">Счет: 0</div>
            
            <div id="game-over-screen">
                <h1>ИГРА ОКОНЧЕНА</h1>
                <p>Ваш счет: <span id="final-score">0</span></p>
                <button id="restart-btn">ИГРАТЬ СНОВА</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            console.log("Страница загружена. Запуск игры...");

            // --- НАСТРОЙКИ ---
            const CANVAS_WIDTH = 400;
            const CANVAS_HEIGHT = window.innerHeight > 800 ? 800 : window.innerHeight - 20;

            // ==========================================
            // 1. БАЗОВЫЙ КЛАСС (ПРИНЦИП ООП: НАСЛЕДОВАНИЕ)
            // ==========================================
            /* 
               Родительский класс. Содержит общие свойства для всех объектов:
               координаты (x, y), размеры (width, height) и цвет.
            */
            class GameObject {
                constructor(x, y, width, height, color) {
                    // ИНКАПСУЛЯЦИЯ: Свойства хранятся внутри объекта (this)
                    this.x = x;
                    this.y = y;
                    this.width = width;
                    this.height = height;
                    this.color = color;
                }

                draw(ctx) {
                    // Базовый метод рисования (прямоугольник)
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }

                update() {
                    // Пустой метод, будет переопределен в потомках
                }
            }

            // ==========================================
            // 2. КЛАСС МАШИНЫ (НАСЛЕДОВАНИЕ + ПОЛИМОРФИЗМ)
            // ==========================================
            class Car extends GameObject {
                constructor(x, y, color, isPlayer = false) {
                    super(x, y, 50, 80, color); // Вызов конструктора родителя
                    this.isPlayer = isPlayer;
                    this.speed = 6;
                    this.dead = false;
                }

                // ПОЛИМОРФИЗМ: Переопределение метода draw.
                // Машина рисуется сложнее, чем просто прямоугольник.
                draw(ctx) {
                    // Тень
                    ctx.fillStyle = "rgba(0,0,0,0.3)";
                    ctx.fillRect(this.x + 5, this.y + 5, this.width, this.height);

                    // Колеса
                    ctx.fillStyle = "black";
                    ctx.fillRect(this.x - 4, this.y + 10, 4, 16); 
                    ctx.fillRect(this.x + this.width, this.y + 10, 4, 16);
                    ctx.fillRect(this.x - 4, this.y + 54, 4, 16);
                    ctx.fillRect(this.x + this.width, this.y + 54, 4, 16);

                    // Кузов
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);

                    // Детали
                    ctx.fillStyle = "#88ccff"; // Стекла
                    ctx.fillRect(this.x + 5, this.y + 15, 40, 15); // Переднее
                    ctx.fillStyle = "rgba(0,0,0,0.2)";
                    ctx.fillRect(this.x + 5, this.y + 55, 40, 12); // Заднее
                }

                update() {
                    if (!this.isPlayer) {
                        this.y += this.speed;
                        // Если уехала вниз за экран
                        if (this.y > CANVAS_HEIGHT) {
                            this.dead = true;
                        }
                    }
                }

                move(dir) {
                    if (dir === "left") this.x -= 25;
                    if (dir === "right") this.x += 25;
                    
                    // Ограничение границами
                    if (this.x < 10) this.x = 10;
                    if (this.x + this.width > CANVAS_WIDTH - 10) {
                        this.x = CANVAS_WIDTH - 10 - this.width;
                    }
                }

                // ИНКАПСУЛЯЦИЯ: Логика проверки удара внутри машины
                isColliding(other) {
                    return (
                        this.x < other.x + other.width &&
                        this.x + this.width > other.x &&
                        this.y < other.y + other.height &&
                        this.y + this.height > other.y
                    );
                }
            }

            // ==========================================
            // 3. КЛАСС ДОРОГИ (НАСЛЕДОВАНИЕ + ПОЛИМОРФИЗМ)
            // ==========================================
            class Road extends GameObject {
                constructor() {
                    super(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT, "#555");
                    this.lineOffset = 0;
                }

                // ПОЛИМОРФИЗМ: Своя логика рисования разметки
                draw(ctx) {
                    // Асфальт
                    ctx.fillStyle = this.color;
                    ctx.fillRect(0, 0, this.width, this.height);

                    // Разметка
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 6;
                    ctx.setLineDash([30, 40]); // Пунктир
                    ctx.lineDashOffset = -this.lineOffset; // Движение пунктира

                    ctx.beginPath();
                    ctx.moveTo(this.width / 2, 0);
                    ctx.lineTo(this.width / 2, this.height);
                    ctx.stroke();
                }

                update() {
                    this.lineOffset += 6; // Скорость анимации дороги
                    if (this.lineOffset > 70) this.lineOffset = 0;
                }
            }

            // ==========================================
            // 4. ГЛАВНЫЙ КЛАСС ИГРЫ (МЕНЕДЖЕР)
            // ==========================================
            class Game {
                constructor() {
                    this.canvas = document.getElementById("canvas");
                    this.ctx = this.canvas.getContext("2d");
                    
                    // Устанавливаем размеры холста
                    this.canvas.width = CANVAS_WIDTH;
                    this.canvas.height = CANVAS_HEIGHT;

                    // UI элементы
                    this.scoreEl = document.getElementById("score-display");
                    this.gameOverScreen = document.getElementById("game-over-screen");
                    this.finalScoreEl = document.getElementById("final-score");
                    this.restartBtn = document.getElementById("restart-btn");

                    this.score = 0;
                    this.isRunning = false;
                    this.animationId = null;

                    // Слушатели событий
                    this.initEvents();
                }

                initEvents() {
                    // Управление
                    document.addEventListener("keydown", (e) => {
                        if (this.isRunning) {
                            if (e.key === "ArrowLeft") this.player.move("left");
                            if (e.key === "ArrowRight") this.player.move("right");
                        }
                    });

                    // Перезапуск
                    this.restartBtn.addEventListener("click", () => {
                        this.start();
                    });
                }

                start() {
                    console.log("Старт игры");
                    this.isRunning = true;
                    this.score = 0;
                    this.scoreEl.innerText = "Счет: 0";
                    this.gameOverScreen.style.display = "none";

                    // Создаем объекты
                    this.road = new Road();
                    // Игрок по центру снизу
                    this.player = new Car(CANVAS_WIDTH / 2 - 25, CANVAS_HEIGHT - 120, "orange", true);
                    this.enemies = [];

                    // Запуск цикла
                    this.loop();
                }

                stop() {
                    this.isRunning = false;
                    cancelAnimationFrame(this.animationId);
                    this.gameOverScreen.style.display = "block";
                    this.finalScoreEl.innerText = this.score;
                }

                loop() {
                    if (!this.isRunning) return;

                    // 1. Очистка
                    this.ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                    // 2. Обновление и отрисовка дороги
                    this.road.update();
                    this.road.draw(this.ctx);

                    // 3. Генерация врагов (2% шанс каждый кадр)
                    if (Math.random() < 0.02) {
                        // Случайная позиция X
                        let ex = Math.random() * (CANVAS_WIDTH - 60) + 5;
                        this.enemies.push(new Car(ex, -100, "red"));
                    }

                    // 4. Работа с врагами
                    this.enemies.forEach((enemy) => {
                        enemy.update();
                        enemy.draw(this.ctx);

                        // Проверка столкновения
                        if (this.player.isColliding(enemy)) {
                            this.stop();
                        }

                        // Если враг проехал, увеличиваем счет
                        if (enemy.dead) {
                            this.score++;
                            this.scoreEl.innerText = "Счет: " + this.score;
                        }
                    });

                    // Удаляем "мертвых" врагов из массива
                    this.enemies = this.enemies.filter(e => !e.dead);

                    // 5. Отрисовка игрока
                    this.player.draw(this.ctx);

                    // Рекурсия
                    this.animationId = requestAnimationFrame(() => this.loop());
                }
            }

            // ЗАПУСК ПРИЛОЖЕНИЯ
            const app = new Game();
            app.start();
        };
    </script>
</body>
</html>